<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Select List</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
    h3 {
      margin-top: 0;
    }
    select {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 14px;
    }
    button {
      background-color: #0079bf;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 3px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    button:hover {
      background-color: #026aa7;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #loading {
      display: none;
      text-align: center;
      margin-top: 10px;
      color: #666;
    }
    #error {
      display: none;
      color: #d32f2f;
      margin-top: 10px;
      padding: 10px;
      background-color: #ffebee;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <h3>Generate List Report</h3>
  <p>Select a list to generate a report:</p>
  <select id="list-select">
    <option value="">Loading lists...</option>
  </select>
  <button id="generate-btn" disabled>Generate Report</button>
  <div id="loading">Generating report, please wait...</div>
  <div id="error"></div>

  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="./constants.js"></script>
  <script src="../shared/auth-helpers.js"></script>
  <script src="./power-up.js"></script>
  <script>
    var t = TrelloPowerUp.iframe({
      appKey: APP_KEY,
      appName: APP_NAME,
    });

    var listSelect = document.getElementById('list-select');
    var generateBtn = document.getElementById('generate-btn');
    var loadingDiv = document.getElementById('loading');
    var errorDiv = document.getElementById('error');

    async function loadLists() {
      try {
        const token = await getAuthToken(t);
        if (!token) {
          errorDiv.textContent = 'Not authorized. Please authorize the Power-Up first.';
          errorDiv.style.display = 'block';
          return;
        }

        const context = t.getContext();
        const boardId = context && context.board;
        if (!boardId) {
          errorDiv.textContent = 'Could not get board context.';
          errorDiv.style.display = 'block';
          return;
        }

        const response = await fetch(
          `https://api.trello.com/1/boards/${boardId}/lists?key=${APP_KEY}&token=${token}`
        );

        if (!response.ok) {
          throw new Error(`Failed to fetch lists: ${response.status}`);
        }

        const lists = await response.json();
        
        listSelect.innerHTML = '<option value="">Select a list...</option>';
        lists.forEach(list => {
          const option = document.createElement('option');
          option.value = list.id;
          option.textContent = list.name;
          listSelect.appendChild(option);
        });

        listSelect.disabled = false;
        generateBtn.disabled = false;
      } catch (error) {
        console.error('Error loading lists:', error);
        errorDiv.textContent = 'Error loading lists: ' + error.message;
        errorDiv.style.display = 'block';
      }
    }

    generateBtn.addEventListener('click', async function() {
      const selectedListId = listSelect.value;
      if (!selectedListId) {
        errorDiv.textContent = 'Please select a list.';
        errorDiv.style.display = 'block';
        return;
      }

      generateBtn.disabled = true;
      listSelect.disabled = true;
      loadingDiv.style.display = 'block';
      errorDiv.style.display = 'none';

      try {
        const listName = listSelect.options[listSelect.selectedIndex].textContent;
        
        // Generate report directly from here
        await generateReport(t, selectedListId, listName);
        
        // Close popup after a short delay to show success
        setTimeout(() => {
          t.closePopup();
        }, 500);
      } catch (error) {
        console.error('Error generating report:', error);
        errorDiv.textContent = 'Error generating report: ' + error.message;
        errorDiv.style.display = 'block';
        generateBtn.disabled = false;
        listSelect.disabled = false;
        loadingDiv.style.display = 'none';
      }
    });

    loadLists();
  </script>
</body>
</html>
